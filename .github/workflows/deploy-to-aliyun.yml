name: éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ECS

on:
  push:
    branches: [ main, master ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'devops/**'
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€æŸ¥Secretsé…ç½®
      env:
        ALIYUN_SSH_KEY: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}
        ALIYUN_HOST: ${{ secrets.ALIYUN_HOST }}
        ALIYUN_USER: ${{ secrets.ALIYUN_USER }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        FRONTEND_PATH: ${{ secrets.FRONTEND_DEPLOY_PATH }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        echo "æ­£åœ¨æ£€æŸ¥å¿…è¦çš„Secretsé…ç½®..."
        if [ -z "$ALIYUN_SSH_KEY" ]; then
          echo "::error::ç¼ºå°‘å¿…è¦çš„Secret: ALIYUN_SSH_PRIVATE_KEY"
          exit 1
        fi
        if [ -z "$ALIYUN_HOST" ]; then
          echo "::error::ç¼ºå°‘å¿…è¦çš„Secret: ALIYUN_HOST"
          exit 1
        fi
        if [ -z "$ALIYUN_USER" ]; then
          echo "::error::ç¼ºå°‘å¿…è¦çš„Secret: ALIYUN_USER"
          exit 1
        fi
        if [ -z "$DEPLOY_PATH" ]; then
          echo "::error::ç¼ºå°‘å¿…è¦çš„Secret: DEPLOY_PATH"
          exit 1
        fi
        if [ -z "$FRONTEND_PATH" ]; then
          echo "::error::ç¼ºå°‘å¿…è¦çš„Secret: FRONTEND_DEPLOY_PATH"
          exit 1
        fi
        if [ -z "$DB_PASSWORD" ]; then
          echo "::warning::æœªè®¾ç½®DB_PASSWORDï¼Œå°†ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„é»˜è®¤å¯†ç "
        fi
        echo "âœ… Secretsæ£€æŸ¥é€šè¿‡"
  
  build-and-deploy:
    needs: prepare
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    # æœåŠ¡å™¨é¢„æ£€æŸ¥å’ŒSSHè®¾ç½®
    - name: éªŒè¯SSHå¯†é’¥æ ¼å¼
      run: |
        echo "æ£€æŸ¥SSHå¯†é’¥æ ¼å¼..."
        # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æ¥å­˜å‚¨SSHå¯†é’¥ï¼Œé¿å…ç›´æ¥åœ¨å‘½ä»¤è¡Œè¾“å‡ºå¯†é’¥
        KEY_FILE=$(mktemp)
        echo "${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}" > $KEY_FILE
        chmod 600 $KEY_FILE
        
        # éªŒè¯SSHå¯†é’¥æ ¼å¼
        if ! grep -q "BEGIN" $KEY_FILE; then
          echo "::error::SSHå¯†é’¥æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘BEGIN PRIVATE KEYè¡Œ"
          echo "æç¤º: ç¡®ä¿åœ¨GitHub Secretsä¸­è®¾ç½®å¯†é’¥æ—¶åŒ…å«äº†å®Œæ•´å†…å®¹ï¼ŒåŒ…æ‹¬BEGINå’ŒENDè¡Œä»¥åŠæ‰€æœ‰æ¢è¡Œç¬¦"
          rm $KEY_FILE
          exit 1
        fi
        
        # æ£€æŸ¥OpenSSHå¯†é’¥æ ¼å¼
        if ! ssh-keygen -l -f $KEY_FILE &>/dev/null; then
          echo "::error::SSHå¯†é’¥æ— æ•ˆæˆ–æ ¼å¼ä¸æ­£ç¡®"
          echo "æç¤º: ä½¿ç”¨ 'ssh-keygen -t ed25519' ç”Ÿæˆæ–°çš„å¯†é’¥ï¼Œå¹¶ç¡®ä¿ä¸Šä¼ åˆ°GitHub Secretsçš„æ˜¯ç§é’¥ï¼ˆé€šå¸¸æ˜¯æ²¡æœ‰.pubåç¼€çš„æ–‡ä»¶ï¼‰"
          rm $KEY_FILE
          exit 1
        fi
        
        echo "SSHå¯†é’¥æ ¼å¼éªŒè¯é€šè¿‡"
        rm $KEY_FILE

    - name: è®¾ç½®SSH Agent
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}
    
    - name: æ·»åŠ æœåŠ¡å™¨åˆ°known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -t rsa,dsa,ecdsa,ed25519 ${{ secrets.ALIYUN_HOST }} >> ~/.ssh/known_hosts
    
    - name: æµ‹è¯•SSHè¿æ¥
      run: |
        echo "æ­£åœ¨æµ‹è¯•SSHè¿æ¥..."
        # å¢åŠ è¿æ¥è¶…æ—¶ï¼Œå¹¶æ·»åŠ è¯¦ç»†è¾“å‡ºä»¥ä¾¿è°ƒè¯•
        ssh -v -o ConnectTimeout=10 ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} 'echo "SSHè¿æ¥æˆåŠŸï¼" && uname -a'
    
    - name: æ£€æŸ¥æœåŠ¡å™¨ç¯å¢ƒ
      id: server-check
      continue-on-error: true
      run: |
        echo "æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨ç¯å¢ƒ..."
        RESULT=$(ssh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} '
          # ç®€åŒ–æ£€æŸ¥ï¼Œåªæ£€æŸ¥å¿…è¦è½¯ä»¶
          MISSING=""
          if ! command -v java &> /dev/null; then MISSING="$MISSING java"; fi
          if ! command -v mysql &> /dev/null; then MISSING="$MISSING mysql"; fi
          if ! command -v nginx &> /dev/null; then MISSING="$MISSING nginx"; fi
          
          if [ -n "$MISSING" ]; then
            echo "åˆå§‹åŒ–"
          else
            echo "å‡†å¤‡å°±ç»ª"
          fi
        ')
        
        echo "æœåŠ¡å™¨çŠ¶æ€: $RESULT"
        echo "server_status=$RESULT" >> $GITHUB_OUTPUT

    # å¦‚æœéœ€è¦åˆå§‹åŒ–ï¼Œä¸Šä¼ å¹¶è¿è¡Œåˆå§‹åŒ–è„šæœ¬
    - name: åˆå§‹åŒ–æœåŠ¡å™¨
      if: steps.server-check.outputs.server_status == 'åˆå§‹åŒ–'
      run: |
        echo "æœåŠ¡å™¨éœ€è¦åˆå§‹åŒ–ï¼Œå‡†å¤‡è¿è¡Œåˆå§‹åŒ–è„šæœ¬..."
        # ä¸Šä¼ å¿…è¦è„šæœ¬
        scp devops/scripts/server-init.sh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:/tmp/
        scp devops/scripts/init-database.sql ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:/tmp/
        scp devops/scripts/init-database.sh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:/tmp/
        
        # æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
        ssh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} '
          # è®¾ç½®æ‰§è¡Œæƒé™
          chmod +x /tmp/server-init.sh
          chmod +x /tmp/init-database.sh
          
          # æ‰§è¡ŒæœåŠ¡å™¨åˆå§‹åŒ–
          sudo /tmp/server-init.sh "${{ secrets.DB_PASSWORD }}" "${{ secrets.DEPLOY_PATH }}" "${{ secrets.FRONTEND_DEPLOY_PATH }}"
        '
    
    # åç«¯æ„å»ºå’Œéƒ¨ç½²
    - name: è®¾ç½®JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'maven'
    
    - name: ä½¿ç”¨Mavenæ„å»ºåç«¯
      run: |
        cd backend
        echo "æ­£åœ¨æ„å»ºåç«¯åº”ç”¨..."
        mvn clean package -DskipTests
        echo "âœ… åç«¯æ„å»ºå®Œæˆ"
    
    - name: éƒ¨ç½²åç«¯åº”ç”¨
      run: |
        echo "æ­£åœ¨éƒ¨ç½²åç«¯åº”ç”¨..."
        # ä¸Šä¼ ç”Ÿäº§ç¯å¢ƒé…ç½®
        scp devops/config/application-prod.yml ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:${{ secrets.DEPLOY_PATH }}/application-prod.yml
        
        # ä¸Šä¼ éƒ¨ç½²è„šæœ¬
        scp devops/scripts/deploy-backend.sh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:${{ secrets.DEPLOY_PATH }}/deploy.sh
        
        # ä¸Šä¼ JARæ–‡ä»¶
        cd backend
        scp target/*.jar ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:${{ secrets.DEPLOY_PATH }}/app.jar
        
        # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
        ssh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} '
          cd ${{ secrets.DEPLOY_PATH }} && 
          chmod +x deploy.sh && 
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}" &&
          ./deploy.sh
        '
    
    # å‰ç«¯æ„å»ºå’Œéƒ¨ç½²
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: å®‰è£…pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9
        run_install: false

    - name: è·å–pnpmç¼“å­˜ç›®å½•
      id: pnpm-cache
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

    - name: è®¾ç½®pnpmç¼“å­˜
      uses: actions/cache@v3
      with:
        path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: å®‰è£…å‰ç«¯ä¾èµ–
      run: |
        cd frontend
        pnpm install --frozen-lockfile
    
    - name: æ„å»ºå‰ç«¯é¡¹ç›®
      run: |
        cd frontend
        echo "å¼€å§‹æ„å»ºå‰ç«¯åº”ç”¨..."
        echo "å½“å‰ç›®å½•: $(pwd)"
        echo "Nodeç‰ˆæœ¬: $(node -v)"
        echo "PNPMç‰ˆæœ¬: $(pnpm -v)"
        NODE_ENV=production VITE_DEBUG=true pnpm run build:prod
        echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
      continue-on-error: false
    
    - name: éƒ¨ç½²å‰ç«¯æ–‡ä»¶
      run: |
        cd frontend
        # æ‰“åŒ…distç›®å½•
        tar -czvf dist.tar.gz -C dist .
        scp dist.tar.gz ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:${{ secrets.FRONTEND_DEPLOY_PATH }}/
        
        # åœ¨æœåŠ¡å™¨ä¸Šè§£å‹
        ssh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} '
          cd ${{ secrets.FRONTEND_DEPLOY_PATH }} &&
          rm -rf * &&
          tar -xzvf dist.tar.gz &&
          rm dist.tar.gz &&
          chmod -R 755 .
        '
    
    # é…ç½®Nginx
    - name: é…ç½®Nginx
      run: |
        # ä¸Šä¼ Nginxé…ç½®è„šæœ¬
        scp devops/scripts/setup-nginx.sh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:/tmp/
        
        # æ‰§è¡ŒNginxé…ç½®
        ssh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} '
          chmod +x /tmp/setup-nginx.sh
          sudo /tmp/setup-nginx.sh "${{ secrets.FRONTEND_DEPLOY_PATH }}" "${{ secrets.DOMAIN_NAME || secrets.ALIYUN_HOST }}"
        '
    
    # éªŒè¯éƒ¨ç½²
    - name: éªŒè¯éƒ¨ç½²
      run: |
        echo "æ­£åœ¨éªŒè¯éƒ¨ç½²..."
        # æ£€æŸ¥åç«¯APIæ˜¯å¦å¯è®¿é—®
        API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://${{ secrets.ALIYUN_HOST }}/api/actuator/health" || echo "Failed")
        
        # æ£€æŸ¥å‰ç«¯æ˜¯å¦å¯è®¿é—®
        FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://${{ secrets.ALIYUN_HOST }}/" || echo "Failed")
        
        echo "APIçŠ¶æ€ç : $API_STATUS"
        echo "å‰ç«¯çŠ¶æ€ç : $FRONTEND_STATUS"
        
        if [ "$API_STATUS" == "200" ]; then
          echo "âœ… åç«¯APIéªŒè¯æˆåŠŸ"
        else
          echo "âš ï¸ åç«¯APIéªŒè¯å¤±è´¥ï¼ŒçŠ¶æ€ç : $API_STATUS"
        fi
        
        if [ "$FRONTEND_STATUS" == "200" ]; then
          echo "âœ… å‰ç«¯éªŒè¯æˆåŠŸ"
        else
          echo "âš ï¸ å‰ç«¯éªŒè¯å¤±è´¥ï¼ŒçŠ¶æ€ç : $FRONTEND_STATUS"
        fi
    
    - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
      run: |
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo "åº”ç”¨åœ°å€: http://${{ secrets.DOMAIN_NAME || secrets.ALIYUN_HOST }}" 