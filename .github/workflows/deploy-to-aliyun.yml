name: éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ECS

on:
  push:
    branches: [ main, master ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'devops/**'
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    # SSHè®¾ç½®
    - name: è®¾ç½®SSH Agent
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}
    
    - name: æ·»åŠ æœåŠ¡å™¨åˆ°known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -t rsa,dsa,ecdsa,ed25519 ${{ secrets.ALIYUN_HOST }} >> ~/.ssh/known_hosts
    
    - name: æµ‹è¯•SSHè¿æ¥
      run: |
        echo "æ­£åœ¨æµ‹è¯•SSHè¿æ¥..."
        ssh -o ConnectTimeout=10 ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} 'echo "SSHè¿æ¥æˆåŠŸï¼"'
    
    # æœåŠ¡å™¨åˆå§‹åŒ–
    - name: åˆå§‹åŒ–æœåŠ¡å™¨
      run: |
        echo "å‡†å¤‡è¿è¡Œåˆå§‹åŒ–è„šæœ¬..."
        # ä¸Šä¼ å¿…è¦è„šæœ¬
        scp devops/scripts/server-init.sh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:/tmp/
        scp devops/scripts/init-database.sql ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:/tmp/
        scp devops/scripts/init-database.sh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:/tmp/
        
        # è®¾ç½®æ‰§è¡Œæƒé™
        ssh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} '
          chmod +x /tmp/server-init.sh
          chmod +x /tmp/init-database.sh
        '
        
        # æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
        ssh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} '
          # æ‰§è¡ŒæœåŠ¡å™¨åˆå§‹åŒ–
          sudo /tmp/server-init.sh "${{ secrets.DB_PASSWORD }}" "${{ secrets.DEPLOY_PATH }}" "${{ secrets.FRONTEND_DEPLOY_PATH }}"
        '
    
    # åç«¯æ„å»ºå’Œéƒ¨ç½²
    - name: è®¾ç½®JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'maven'
    
    - name: ä½¿ç”¨Mavenæ„å»ºåç«¯
      run: |
        cd backend
        echo "æ­£åœ¨æ„å»ºåç«¯åº”ç”¨..."
        mvn clean package -DskipTests
        echo "âœ… åç«¯æ„å»ºå®Œæˆ"
    
    - name: éƒ¨ç½²åç«¯åº”ç”¨
      run: |
        echo "æ­£åœ¨éƒ¨ç½²åç«¯åº”ç”¨..."
        # ä¸Šä¼ ç”Ÿäº§ç¯å¢ƒé…ç½®
        scp devops/config/application-prod.yml ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:${{ secrets.DEPLOY_PATH }}/application-prod.yml
        
        # ä¸Šä¼ éƒ¨ç½²è„šæœ¬
        scp devops/scripts/deploy-backend.sh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:${{ secrets.DEPLOY_PATH }}/deploy.sh
        
        # ä¸Šä¼ JARæ–‡ä»¶
        cd backend
        scp target/*.jar ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:${{ secrets.DEPLOY_PATH }}/app.jar
        
        # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
        ssh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} '
          cd ${{ secrets.DEPLOY_PATH }} && 
          chmod +x deploy.sh && 
          ./deploy.sh
        '
    
    # å‰ç«¯æ„å»ºå’Œéƒ¨ç½²
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: å®‰è£…pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9
        run_install: false
    
    - name: å®‰è£…å‰ç«¯ä¾èµ–
      run: |
        cd frontend
        pnpm install --frozen-lockfile
    
    - name: æ„å»ºå‰ç«¯é¡¹ç›®
      run: |
        cd frontend
        echo "å¼€å§‹æ„å»ºå‰ç«¯åº”ç”¨..."
        NODE_ENV=production pnpm run build:prod
        echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
    
    - name: éƒ¨ç½²å‰ç«¯æ–‡ä»¶
      run: |
        cd frontend
        # æ‰“åŒ…distç›®å½•
        tar -czvf dist.tar.gz -C dist .
        scp dist.tar.gz ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:${{ secrets.FRONTEND_DEPLOY_PATH }}/
        
        # åœ¨æœåŠ¡å™¨ä¸Šè§£å‹
        ssh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} '
          cd ${{ secrets.FRONTEND_DEPLOY_PATH }} &&
          rm -rf * &&
          tar -xzvf dist.tar.gz &&
          rm dist.tar.gz &&
          chmod -R 755 .
        '
    
    # é…ç½®Nginx
    - name: é…ç½®Nginx
      run: |
        # ä¸Šä¼ Nginxé…ç½®è„šæœ¬
        scp devops/scripts/setup-nginx.sh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:/tmp/
        
        # æ‰§è¡ŒNginxé…ç½®
        ssh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} '
          chmod +x /tmp/setup-nginx.sh
          sudo /tmp/setup-nginx.sh "${{ secrets.FRONTEND_DEPLOY_PATH }}" "${{ secrets.DOMAIN_NAME || secrets.ALIYUN_HOST }}"
        '
    
    - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
      run: |
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo "åº”ç”¨åœ°å€: http://${{ secrets.DOMAIN_NAME || secrets.ALIYUN_HOST }}" 