name: éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ECS

on:
  push:
    branches: [ main, master ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'devops/**'
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    # SSHè®¾ç½®
    - name: è®¾ç½®SSH Agent
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}
    
    - name: æ·»åŠ æœåŠ¡å™¨åˆ°known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -t rsa,dsa,ecdsa,ed25519 ${{ secrets.ALIYUN_HOST }} >> ~/.ssh/known_hosts
    
    - name: æµ‹è¯•SSHè¿æ¥
      run: |
        echo "æ­£åœ¨æµ‹è¯•SSHè¿æ¥..."
        ssh -o ConnectTimeout=10 ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} 'echo "SSHè¿æ¥æˆåŠŸï¼"'
    
    # æœåŠ¡å™¨åˆå§‹åŒ–
    - name: åˆå§‹åŒ–æœåŠ¡å™¨
      run: |
        echo "å‡†å¤‡è¿è¡Œåˆå§‹åŒ–è„šæœ¬..."
        # ä¸Šä¼ å¿…è¦è„šæœ¬
        scp devops/scripts/server-init.sh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:/tmp/
        scp devops/scripts/init-database.sql ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:/tmp/
        scp devops/scripts/init-database.sh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:/tmp/
        
        # è®¾ç½®æ‰§è¡Œæƒé™
        ssh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} '
          chmod +x /tmp/server-init.sh
          chmod +x /tmp/init-database.sh
        '
        
        # æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
        ssh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} '
          # æ‰§è¡ŒæœåŠ¡å™¨åˆå§‹åŒ–
          sudo /tmp/server-init.sh "${{ secrets.DB_PASSWORD }}" "${{ secrets.DEPLOY_PATH }}" "${{ secrets.FRONTEND_DEPLOY_PATH }}"
        '
    
    # åç«¯æ„å»ºå’Œéƒ¨ç½²
    - name: è®¾ç½®JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'maven'
    
    - name: ä½¿ç”¨Mavenæ„å»ºåç«¯
      run: |
        cd backend
        echo "æ­£åœ¨æ„å»ºåç«¯åº”ç”¨..."
        mvn clean package -DskipTests
        echo "âœ… åç«¯æ„å»ºå®Œæˆ"
    
    - name: éƒ¨ç½²åç«¯åº”ç”¨
      run: |
        echo "æ­£åœ¨éƒ¨ç½²åç«¯åº”ç”¨..."
        # å¤„ç†é…ç½®æ–‡ä»¶ - å®‰å…¨åœ°æ›¿æ¢å ä½ç¬¦
        TEMP_CONFIG=$(mktemp)
        # ä½¿ç”¨perlä»£æ›¿sedï¼Œæ›´å®‰å…¨åœ°å¤„ç†ç‰¹æ®Šå­—ç¬¦
        perl -p -e 's/\$\{DB_PASSWORD:your_password_here\}/$ENV{DB_PASSWORD}/g' devops/config/application-prod.yml > $TEMP_CONFIG
        DB_PASSWORD="${{ secrets.DB_PASSWORD }}" # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›perlä½¿ç”¨
        
        # ä¸Šä¼ å¤„ç†åçš„ç”Ÿäº§ç¯å¢ƒé…ç½®
        scp $TEMP_CONFIG ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:${{ secrets.DEPLOY_PATH }}/application-prod.yml
        rm $TEMP_CONFIG
        
        # ä¸Šä¼ éƒ¨ç½²è„šæœ¬
        scp devops/scripts/deploy-backend.sh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:${{ secrets.DEPLOY_PATH }}/deploy.sh
        
        # ä¸Šä¼ JARæ–‡ä»¶
        cd backend
        scp target/*.jar ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:${{ secrets.DEPLOY_PATH }}/app.jar
        
        # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
        ssh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} '
          cd ${{ secrets.DEPLOY_PATH }} && 
          chmod +x deploy.sh && 
          ./deploy.sh "${{ secrets.DEPLOY_PATH }}" "${{ secrets.DB_PASSWORD }}"
        '
    
    # å‰ç«¯æ„å»ºå’Œéƒ¨ç½²
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: å®‰è£…pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9
        run_install: false
    
    - name: å®‰è£…å‰ç«¯ä¾èµ–
      run: |
        cd frontend
        pnpm install --frozen-lockfile
    
    - name: æ„å»ºå‰ç«¯é¡¹ç›®
      run: |
        cd frontend
        echo "å¼€å§‹æ„å»ºå‰ç«¯åº”ç”¨..."
        # æ£€æŸ¥Viteé…ç½®æ–‡ä»¶
        if [ -f "vite.config.ts" ]; then
          echo "æ£€æµ‹åˆ°Viteé…ç½®æ–‡ä»¶ï¼Œæ·»åŠ æ˜ç¡®çš„è¾“å‡ºç›®å½•è®¾ç½®..."
          # ä¸´æ—¶æ·»åŠ è¾“å‡ºç›®å½•é…ç½®
          sed -i '/build: {/a \    outDir: "dist",' vite.config.ts
          cat vite.config.ts
        fi
        
        NODE_ENV=production pnpm run build:prod
        echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
        
        # æ£€æŸ¥æ„å»ºç›®å½•ç»“æ„
        echo "æ£€æŸ¥æ„å»ºè¾“å‡ºç›®å½•ç»“æ„..."
        ls -la
        if [ -d "dist" ]; then
          echo "distç›®å½•å†…å®¹:"
          ls -la dist
        else
          echo "è­¦å‘Š: æ²¡æœ‰æ‰¾åˆ°distç›®å½•ï¼Œåˆ—å‡ºå½“å‰ç›®å½•å†…å®¹:"
          ls -la
          echo "å¯»æ‰¾æ„å»ºäº§ç‰©..."
          find . -type f -name "*.js" | head -5
          find . -type f -name "*.css" | head -5
          find . -type f -name "index.html" | head -1
        fi
    
    - name: éƒ¨ç½²å‰ç«¯æ–‡ä»¶
      run: |
        cd frontend
        
        # æ£€æŸ¥æ„å»ºè¾“å‡ºç›®å½•
        BUILD_DIR="dist"
        if [ ! -d "$BUILD_DIR" ]; then
          echo "è­¦å‘Š: æœªæ‰¾åˆ°æ ‡å‡†distç›®å½•ï¼Œå°è¯•æŸ¥æ‰¾å®é™…çš„æ„å»ºè¾“å‡º..."
          
          # é¦–å…ˆå°è¯•æŸ¥æ‰¾index.htmlä½ç½®
          INDEX_HTML_PATH=$(find . -type f -name "index.html" | grep -v "node_modules" | head -1)
          
          if [ -n "$INDEX_HTML_PATH" ]; then
            # æå–ç›®å½•éƒ¨åˆ† (å¦‚æœåœ¨æ ¹ç›®å½•,åˆ™ä¸º".")
            INDEX_DIR=$(dirname "$INDEX_HTML_PATH")
            echo "æ‰¾åˆ°index.htmlåœ¨: $INDEX_DIR"
            
            if [ "$INDEX_DIR" = "." ]; then
              echo "æ„å»ºæ–‡ä»¶åœ¨å½“å‰ç›®å½•ï¼Œåˆ›å»ºä¸´æ—¶ç›®å½•æ¥æ”¶é›†æ–‡ä»¶..."
              mkdir -p temp-dist
              # å¤åˆ¶æ‰€æœ‰å¯èƒ½çš„æ„å»ºäº§ç‰©
              cp -r *.js *.css *.html *.ico assets/ temp-dist/ 2>/dev/null || true
              BUILD_DIR="temp-dist"
            else
              BUILD_DIR="$INDEX_DIR"
              echo "ä½¿ç”¨æ„å»ºç›®å½•: $BUILD_DIR"
            fi
          else
            echo "æœªæ‰¾åˆ°index.htmlï¼Œåˆ›å»ºä¸´æ—¶ç›®å½•æ”¶é›†æ‰€æœ‰å¯èƒ½çš„æ„å»ºæ–‡ä»¶..."
            mkdir -p temp-dist
            
            # æŸ¥æ‰¾å¹¶æ”¶é›†æ‰€æœ‰JSå’ŒCSSæ–‡ä»¶ï¼Œä½†æ’é™¤node_modules
            find . -type f \( -name "*.js" -o -name "*.css" -o -name "*.html" -o -name "*.ico" \) \
              -not -path "./node_modules/*" -not -path "./src/*" \
              -exec cp --parents {} temp-dist/ \; 2>/dev/null || true
            
            # å¤åˆ¶assetsç›®å½•å¦‚æœå­˜åœ¨
            if [ -d "assets" ]; then
              cp -r assets temp-dist/
            fi
            
            BUILD_DIR="temp-dist"
          fi
        else
          echo "ä½¿ç”¨æ ‡å‡†distç›®å½•"
        fi
        
        echo "å‡†å¤‡æ‰“åŒ…ç›®å½•: $BUILD_DIR"
        # æ£€æŸ¥æ„å»ºç›®å½•ä¸­æ˜¯å¦æœ‰æ–‡ä»¶
        if [ -z "$(ls -A $BUILD_DIR 2>/dev/null)" ]; then
          echo "é”™è¯¯: æ„å»ºç›®å½•ä¸ºç©ºï¼Œæ— æ³•ç»§ç»­éƒ¨ç½²"
          echo "å½“å‰å·¥ä½œç›®å½•å†…å®¹:"
          ls -la
          exit 1
        fi
        
        # åˆ›å»ºå‹ç¼©åŒ…
        echo "åˆ›å»ºå‹ç¼©åŒ…..."
        tar -czvf frontend-dist.tar.gz -C $BUILD_DIR .
        
        # ä¸Šä¼ å‹ç¼©åŒ…
        echo "ä¸Šä¼ å‰ç«¯æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
        scp frontend-dist.tar.gz ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:${{ secrets.FRONTEND_DEPLOY_PATH }}/
        
        # åœ¨æœåŠ¡å™¨ä¸Šè§£å‹
        ssh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} '
          cd ${{ secrets.FRONTEND_DEPLOY_PATH }} &&
          mkdir -p backup &&
          if [ -f "index.html" ]; then
            echo "åˆ›å»ºå½“å‰æ–‡ä»¶å¤‡ä»½..." &&
            cp -r * backup/ 2>/dev/null || true
          fi &&
          echo "æ¸…ç†ç›®å½•..." &&
          rm -rf *.js *.css *.html *.ico assets/ &&
          echo "è§£å‹æ–°æ–‡ä»¶..." &&
          tar -xzvf frontend-dist.tar.gz &&
          rm frontend-dist.tar.gz &&
          echo "è®¾ç½®æƒé™..." &&
          chmod -R 755 .
        '
    
    # é…ç½®Nginx
    - name: é…ç½®Nginx
      run: |
        # ä¸Šä¼ Nginxé…ç½®è„šæœ¬
        scp devops/scripts/setup-nginx.sh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }}:/tmp/
        
        # æ‰§è¡ŒNginxé…ç½®
        ssh ${{ secrets.ALIYUN_USER }}@${{ secrets.ALIYUN_HOST }} '
          chmod +x /tmp/setup-nginx.sh
          sudo /tmp/setup-nginx.sh "${{ secrets.FRONTEND_DEPLOY_PATH }}" "${{ secrets.DOMAIN_NAME || secrets.ALIYUN_HOST }}"
        '
    
    - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
      run: |
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
        echo "åº”ç”¨åœ°å€: http://${{ secrets.DOMAIN_NAME || secrets.ALIYUN_HOST }}" 