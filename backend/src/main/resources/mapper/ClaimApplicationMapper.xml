<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.community.lostandfound.repository.ClaimApplicationRepository">
    
    <!-- 定义结果映射 -->
    <resultMap id="ClaimApplicationResultMap" type="com.community.lostandfound.entity.ClaimApplication">
        <id property="id" column="id" />
        <result property="foundItemId" column="found_item_id" />
        <result property="applicantId" column="applicant_id" />
        <result property="description" column="description" />
        <result property="status" column="status" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
        <result property="processedAt" column="processed_at" />
        <result property="applicantName" column="applicant_name" />
        <result property="applicantContact" column="applicant_contact" />
        <result property="foundItemTitle" column="found_item_title" />
        <result property="foundItemOwnerId" column="owner_id" />
        <result property="foundItemOwnerName" column="owner_name" />
    </resultMap>
    
    <!-- SQL片段 -->
    <sql id="selectClaimApplicationWithDetails">
        SELECT 
            ca.*,
            a.username as applicant_name,
            a.phone as applicant_contact,
            f.title as found_item_title,
            f.user_id as owner_id,
            o.username as owner_name
        FROM claim_applications ca
        LEFT JOIN users a ON ca.applicant_id = a.id
        LEFT JOIN found_items f ON ca.found_item_id = f.id
        LEFT JOIN users o ON f.user_id = o.id
    </sql>
    
    <!-- 保存认领申请 -->
    <insert id="save" parameterType="com.community.lostandfound.entity.ClaimApplication" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO claim_applications (
            found_item_id, applicant_id, description, status, created_at, updated_at
        ) VALUES (
            #{foundItemId}, #{applicantId}, #{description}, #{status}, #{createdAt}, #{updatedAt}
        )
    </insert>
    
    <!-- 更新认领申请 -->
    <update id="update" parameterType="com.community.lostandfound.entity.ClaimApplication">
        UPDATE claim_applications SET
            status = #{status},
            updated_at = #{updatedAt},
            processed_at = #{processedAt}
        WHERE id = #{id}
    </update>
    
    <!-- 删除认领申请 -->
    <delete id="deleteById">
        DELETE FROM claim_applications WHERE id = #{id}
    </delete>
    
    <!-- 查询所有认领申请（分页） -->
    <select id="findAll" resultMap="ClaimApplicationResultMap">
        <include refid="selectClaimApplicationWithDetails" />
        <where>
            <if test="status != null and status != ''">
                AND ca.status = #{status}
            </if>
        </where>
        ORDER BY ca.created_at DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>
    
    <!-- 根据ID查询认领申请 -->
    <select id="findById" resultMap="ClaimApplicationResultMap">
        <include refid="selectClaimApplicationWithDetails" />
        WHERE ca.id = #{id}
    </select>
    
    <!-- 统计认领申请总数 -->
    <select id="count" resultType="long">
        SELECT COUNT(*) FROM claim_applications
        <where>
            <if test="status != null and status != ''">
                status = #{status}
            </if>
        </where>
    </select>
    
    <!-- 根据失物招领ID查询认领申请（分页） -->
    <select id="findByFoundItemId" resultMap="ClaimApplicationResultMap">
        <include refid="selectClaimApplicationWithDetails" />
        WHERE ca.found_item_id = #{foundItemId}
        ORDER BY ca.created_at DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>
    
    <!-- 统计指定失物招领的认领申请总数 -->
    <select id="countByFoundItemId" resultType="long">
        SELECT COUNT(*) FROM claim_applications
        WHERE found_item_id = #{foundItemId}
    </select>
    
    <!-- 根据用户ID查询该用户提交的认领申请（分页） -->
    <select id="findByApplicantId" resultMap="ClaimApplicationResultMap">
        <include refid="selectClaimApplicationWithDetails" />
        WHERE ca.applicant_id = #{applicantId}
        <if test="status != null and status != ''">
            AND ca.status = #{status}
        </if>
        ORDER BY ca.created_at DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>
    
    <!-- 统计指定用户提交的认领申请总数 -->
    <select id="countByApplicantId" resultType="long">
        SELECT COUNT(*) FROM claim_applications
        WHERE applicant_id = #{applicantId}
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
    </select>
    
    <!-- 查询需要由用户处理的认领申请（分页）-->
    <select id="findByFoundItemOwnerId" resultMap="ClaimApplicationResultMap">
        <include refid="selectClaimApplicationWithDetails" />
        WHERE f.user_id = #{ownerId}
        <if test="status != null and status != ''">
            AND ca.status = #{status}
        </if>
        ORDER BY ca.created_at DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>
    
    <!-- 统计指定用户需要处理的认领申请总数 -->
    <select id="countByFoundItemOwnerId" resultType="long">
        SELECT COUNT(*) FROM claim_applications ca
        JOIN found_items f ON ca.found_item_id = f.id
        WHERE f.user_id = #{ownerId}
        <if test="status != null and status != ''">
            AND ca.status = #{status}
        </if>
    </select>
    
    <!-- 检查用户是否已经申请认领某个失物招领 -->
    <select id="existsByFoundItemIdAndApplicantId" resultType="boolean">
        SELECT COUNT(*) > 0 FROM claim_applications
        WHERE found_item_id = #{foundItemId} AND applicant_id = #{applicantId}
    </select>
    
    <!-- 根据失物招领ID和状态查询认领申请 -->
    <select id="findByFoundItemIdAndStatus" resultMap="ClaimApplicationResultMap">
        <include refid="selectClaimApplicationWithDetails" />
        WHERE ca.found_item_id = #{foundItemId} AND ca.status = #{status}
    </select>
    
    <!-- 检查失物招领是否有已批准的认领申请 -->
    <select id="hasApprovedApplication" resultType="boolean">
        SELECT COUNT(*) > 0 FROM claim_applications
        WHERE found_item_id = #{foundItemId} AND status = 'approved'
    </select>
</mapper> 